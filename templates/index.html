<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Cat Feeding Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .kmono { font-variant-numeric: tabular-nums; }
    .table-sm td, .table-sm th { padding: .35rem; }
    .cat-profile-picture {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid #dee2e6;
    }
    .cat-profile-display {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .profile-info-row {
      display: flex;
      align-items: center;
      gap: 20px;
    }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h2 class="mb-4">üê± Cat Feeding Planner</h2>

  <!-- Cat Selector -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-10">
          <form method="post" id="catSelectorForm">
            <input type="hidden" name="action" value="select_cat">
            <label class="form-label fw-bold">Select Cat</label>
            <select name="selected_cat_id" class="form-select" onchange="document.getElementById('catSelectorForm').submit()">
              {% if cats|length == 0 %}
                <option value="">No cats yet - click "Add New Cat" to create one</option>
              {% else %}
                {% for cat in cats %}
                  <option value="{{ cat.id }}" {% if cat.id == selected_cat_id %}selected{% endif %}>
                    {{ cat.name or "Unnamed Cat" }}
                  </option>
                {% endfor %}
              {% endif %}
            </select>
          </form>
        </div>
        <div class="col-md-2">
          <form method="post" id="addCatForm">
            <input type="hidden" name="action" value="add_cat">
            <label class="form-label fw-bold">&nbsp;</label>
            <button class="btn btn-success w-100" type="submit" onclick="document.getElementById('addCatForm').submit()">‚ûï Add New Cat</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Toast -->
  {% if show_success %}
  <div class="alert alert-success alert-dismissible fade show" role="alert" id="successToast">
    <strong>‚úÖ Success!</strong> Cat profile saved successfully.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <script>
    setTimeout(function() {
      var toast = document.getElementById('successToast');
      if (toast) {
        var bsAlert = new bootstrap.Alert(toast);
        bsAlert.close();
      }
    }, 3000);
  </script>
  {% endif %}

  {% if selected_cat_id and prof %}
  <!-- Cat Profile Display (Always Visible) -->
  <div class="cat-profile-display">
    <div class="profile-info-row">
      {% if prof.profile_picture %}
        <img src="{{ prof.profile_picture }}" alt="{{ prof.name or 'Cat' }}" class="cat-profile-picture">
      {% else %}
        <div class="cat-profile-picture bg-light d-flex align-items-center justify-content-center" style="background-color: rgba(255,255,255,0.2)!important;">
          <span style="font-size: 3rem;">üê±</span>
        </div>
      {% endif %}
      <div class="flex-grow-1">
        <h3 class="mb-2">{{ prof.name or "Unnamed Cat" }}</h3>
        <div class="row g-2">
          <div class="col-auto"><strong>Current Age:</strong> {{ "%.1f"|format(age_weeks) }} weeks</div>
          <div class="col-auto"><strong>Life Stage:</strong> {{ stage.replace('_', ' ').title() }}</div>
          <div class="col-auto"><strong>Meals per Day:</strong> {{ prof.meals_per_day }}</div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Profile Edit Form -->
  <div class="card mb-3">
    <div class="card-header bg-primary text-white" style="cursor: pointer;" onclick="toggleProfileSection()">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          {% if prof and prof.profile_picture %}
            <img src="{{ prof.profile_picture }}" alt="{{ prof.name or 'Cat' }}" class="cat-profile-picture" style="width: 50px; height: 50px;">
          {% elif prof and prof.name %}
            <div class="cat-profile-picture bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; background-color: rgba(255,255,255,0.2)!important;">
              <span style="font-size: 1.5rem;">üê±</span>
            </div>
          {% endif %}
          <h5 class="mb-0">
            üìù Cat Profile Information
            {% if prof and prof.name %}
              - <span>{{ prof.name }}</span>
            {% endif %}
          </h5>
        </div>
        <span id="profileToggleIcon">‚ñº</span>
      </div>
    </div>
    <div class="card-body" id="profileSection" {% if not expand_profile and prof and prof.name %}style="display: none;"{% endif %}>
      <form method="post" enctype="multipart/form-data" class="row g-3">
        <input type="hidden" name="action" value="save_profile">
        {% if selected_cat_id %}<input type="hidden" name="selected_cat_id" value="{{ selected_cat_id }}">{% endif %}
        
        <div class="col-md-4">
          <label class="form-label fw-bold">Cat's Name</label>
          <input name="name" value="{{ prof.name or '' }}" class="form-control" placeholder="Enter your cat's name">
        </div>
        
        <div class="col-md-4">
          <label class="form-label fw-bold">Reference Date</label>
          <input type="date" name="anchor_date" value="{{ prof.anchor_date }}" class="form-control" required>
          <small class="text-muted">The date when you started tracking</small>
        </div>
        
        <div class="col-md-4">
          <label class="form-label fw-bold">Age at Reference Date (weeks)</label>
          <input type="number" step="0.5" name="anchor_age_weeks" value="{{ prof.anchor_age_weeks }}" class="form-control" required>
          <small class="text-muted">How old was your cat on the reference date?</small>
        </div>
        
        <div class="col-md-4">
          <label class="form-label fw-bold">Meals Per Day</label>
          <input type="number" name="meals_per_day" min="1" max="12" value="{{ prof.meals_per_day }}" class="form-control" required>
          <small class="text-muted">How many times do you feed your cat daily?</small>
        </div>
        
        <div class="col-md-4">
          <label class="form-label fw-bold">Life Stage (Optional)</label>
          <select name="life_stage_override" class="form-select">
            {% set stages = [
              ("", "Auto-detect based on age"),
              ("kitten_0_4m", "Kitten 0-4 months"),
              ("kitten_4_12m", "Kitten 4-12 months"),
              ("adult_neutered", "Adult (Neutered)"),
              ("adult_intact", "Adult (Not Neutered)"),
              ("adult_obese_prone", "Adult (Prone to Obesity)")
            ] %}
            {% for val, label in stages %}
            <option value="{{ val }}" {% if prof.life_stage_override==val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <small class="text-muted">Leave as "Auto-detect" unless you want to override</small>
        </div>
        
        <div class="col-md-4">
          <label class="form-label fw-bold">Profile Picture</label>
          <input type="file" name="profile_picture" class="form-control" accept="image/jpeg,image/png,image/gif">
          <small class="text-muted">Upload a photo of your cat (JPG, PNG, or GIF)</small>
        </div>
        
        <div class="col-12">
          <button class="btn btn-primary btn-lg">üíæ Save Profile</button>
          {% if prof.name %}
          <span class="ms-3 text-muted">
            <strong>Current Status:</strong> {{ prof.name }} is {{ "%.1f"|format(age_weeks) }} weeks old 
            ({{ stage.replace('_', ' ').title() }})
          </span>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card text-center border-primary">
        <div class="card-body">
          <div class="text-muted mb-2">Latest Weight</div>
          <div class="h3 kmono text-primary">{{ "%.2f"|format(latest_w) if latest_w else "‚Äî" }} <small class="fs-6">kg</small></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center border-success">
        <div class="card-body">
          <div class="text-muted mb-2">Daily Calorie Target</div>
          <div class="h3 kmono text-success">{{ "%.0f"|format(daily_kcal) if daily_kcal else "‚Äî" }} <small class="fs-6">kcal</small></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center border-info">
        <div class="card-body">
          <div class="text-muted mb-2">Feeding Schedule</div>
          <div class="h3 kmono text-info">{{ prof.meals_per_day if prof else "‚Äî" }} <small class="fs-6">meals/day</small></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="tabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dash" type="button">üìä Dashboard</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#log" type="button">üìù Weight Log</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#foods" type="button">üçΩÔ∏è Food Library</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#diet" type="button">ü•ó Diet Plan</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#calc" type="button">üìñ How It Works</button></li>
  </ul>

  <div class="tab-content border border-top-0 p-4 bg-white">
    <!-- Dashboard -->
    <div class="tab-pane fade show active" id="dash">
      <h5 class="mb-3">üìã Feeding Plan Per Meal</h5>
      {% if per_meal|length == 0 %}
      <div class="alert alert-info">
        <strong>Getting Started:</strong> To see your feeding plan, please:
        <ol class="mb-0 mt-2">
          <li>Add at least one weight measurement in the "Weight Log" tab</li>
          <li>Add foods to your "Food Library"</li>
          <li>Create a diet plan in the "Diet Plan" tab (must total 100%)</li>
        </ol>
      </div>
      {% else %}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Food</th>
              <th>% of Daily Calories</th>
              <th>Daily Calories</th>
              <th>Per Meal Calories</th>
              <th>Amount Per Meal</th>
              <th>Unit</th>
              <th>Grams Per Meal</th>
            </tr>
          </thead>
          <tbody>
          {% for r in per_meal %}
            <tr>
              <td><strong>{{ r.Food }}</strong></td>
              <td class="kmono">{{ "%.1f"|format(r.pct) }}%</td>
              <td class="kmono">{{ "%.1f"|format(r.kcal_day) }} kcal</td>
              <td class="kmono">{{ "%.1f"|format(r.kcal_meal) }} kcal</td>
              <td class="kmono">{{ "%.3f"|format(r.qty_per_meal) }}</td>
              <td>{{ r.unit }}</td>
              <td class="kmono">{{ r.grams_per_meal if r.grams_per_meal is not none else "‚Äî" }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <div class="row g-3 mt-4">
        <div class="col-md-6">
          <h6 class="mb-3">üìà Weight Over Time</h6>
          <canvas id="wChart"></canvas>
        </div>
        <div class="col-md-6">
          <h6 class="mb-3">üî• Daily Calorie Target Over Time</h6>
          <canvas id="kChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Weight Log -->
    <div class="tab-pane fade" id="log">
      <h5 class="mb-3">üìù Record Weight Measurements</h5>
      <form method="post" class="row g-3 mb-4">
        <input type="hidden" name="action" value="add_weight">
        {% if selected_cat_id %}<input type="hidden" name="selected_cat_id" value="{{ selected_cat_id }}">{% endif %}
        <div class="col-md-4">
          <label class="form-label fw-bold">Date</label>
          <input type="date" name="weight_dt" value="{{ (weights_list[-1].dt if weights_list|length>0 else '') or (('%Y-%m-%d')|strftime) }}" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-bold">Weight (kilograms)</label>
          <input type="number" step="0.01" min="0.1" name="weight_kg" class="form-control" placeholder="e.g., 3.5" required>
        </div>
        <div class="col-md-4 align-self-end">
          <button class="btn btn-primary">üíæ Save Weight</button>
        </div>
      </form>
      
      <h6 class="mb-3">üìã Weight History</h6>
      {% if weights_list|length == 0 %}
      <div class="alert alert-warning">No weight measurements recorded yet. Add your first measurement above!</div>
      {% else %}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Weight (kg)</th>
            </tr>
          </thead>
          <tbody>
          {% for r in weights_list|reverse %}
            <tr>
              <td class="kmono">{{ r.dt }}</td>
              <td class="kmono"><strong>{{ "%.2f"|format(r.weight_kg) }} kg</strong></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>

    <!-- Foods -->
    <div class="tab-pane fade" id="foods">
      <h5 class="mb-3">üçΩÔ∏è Food Library</h5>
      <p class="text-muted mb-4">Add foods that you feed your cat. This library is shared across all your cats.</p>
      
      <div class="card mb-4">
        <div class="card-header bg-light">
          <strong>‚ûï Add New Food</strong>
        </div>
        <div class="card-body">
          <form method="post" class="row g-3">
            <input type="hidden" name="action" value="add_food">
            <div class="col-md-4">
              <label class="form-label fw-bold">Food Name</label>
              <input name="food_name" class="form-control" placeholder="e.g., Premium Cat Food" required>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold">Measurement Unit</label>
              <select name="food_unit" class="form-select">
                <option value="kcal_per_g">Calories per gram</option>
                <option value="kcal_per_cup">Calories per cup</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold">Calories per Unit</label>
              <input type="number" step="0.1" name="kcal_per_unit" class="form-control" placeholder="e.g., 3.5" required>
            </div>
            <div class="col-md-2">
              <label class="form-label fw-bold">Grams per Cup</label>
              <input type="number" step="1" name="grams_per_cup" class="form-control" placeholder="If using cups">
              <small class="text-muted">Only if using "per cup"</small>
            </div>
            <div class="col-12">
              <button class="btn btn-success">‚ûï Add Food</button>
            </div>
          </form>
        </div>
      </div>

      <h6 class="mb-3">üìö Your Food Library</h6>
      {% if foods|length == 0 %}
      <div class="alert alert-info">No foods added yet. Add your first food above!</div>
      {% else %}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Food Name</th>
              <th>Unit Type</th>
              <th>Calories per Unit</th>
              <th>Grams per Cup</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          {% for f in foods %}
            <tr>
              <td><strong>{{ f.name }}</strong></td>
              <td>{{ "Per gram" if f.unit == "kcal_per_g" else "Per cup" }}</td>
              <td class="kmono">{{ "%.1f"|format(f.kcal_per_unit) }} kcal</td>
              <td class="kmono">{{ f.grams_per_cup if f.grams_per_cup else "‚Äî" }}</td>
              <td>
                <form method="post" class="d-inline">
                  <input type="hidden" name="action" value="delete_food">
                  <input type="hidden" name="del_food_id" value="{{ f.id }}">
                  <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete {{ f.name }}?')">üóëÔ∏è Delete</button>
                </form>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>

    <!-- Diet Plan -->
    <div class="tab-pane fade" id="diet">
      <h5 class="mb-3">ü•ó Create Diet Plan</h5>
      <p class="text-muted mb-4">Set what percentage of daily calories should come from each food. The total must equal 100%.</p>
      
      {% if foods|length == 0 %}
      <div class="alert alert-warning">
        <strong>No foods available!</strong> Please add foods to your Food Library first.
      </div>
      {% else %}
      <form method="post">
        <input type="hidden" name="action" value="save_diet">
        {% if selected_cat_id %}<input type="hidden" name="selected_cat_id" value="{{ selected_cat_id }}">{% endif %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Food</th>
                <th style="max-width:200px;">Percentage of Daily Calories (%)</th>
              </tr>
            </thead>
            <tbody>
            {% for f in foods %}
              <tr>
                <td><strong>{{ f.name }}</strong></td>
                <td>
                  <input class="form-control" type="number" step="1" min="0" max="100"
                         name="diet_pct_{{ f.id }}" value="{{ diet_map.get(f.id, 0.0) }}" required>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="alert alert-info mt-3">
          <strong>Total:</strong> <span class="kmono fs-5">{{ "%.1f"|format(total_pct) }}</span>% 
          {% if total_pct != 100.0 %}
            <span class="text-danger">‚ö†Ô∏è Must equal exactly 100%</span>
          {% else %}
            <span class="text-success">‚úÖ Perfect!</span>
          {% endif %}
        </div>
        <button class="btn btn-primary btn-lg">üíæ Save Diet Plan</button>
      </form>
      {% endif %}
    </div>

    <!-- How It Works -->
    <div class="tab-pane fade" id="calc">
      <h5 class="mb-3">üìñ How Calorie Targets Are Calculated</h5>
      
      <div class="card mb-4">
        <div class="card-header bg-light">
          <strong>üî¢ The Formula</strong>
        </div>
        <div class="card-body">
          <p>We use a two-step calculation:</p>
          <ol>
            <li><strong>RER (Resting Energy Requirement)</strong> = 70 √ó Weight(kg)<sup>0.75</sup></li>
            <li><strong>DER (Daily Energy Requirement)</strong> = RER √ó Life Stage Factor</li>
          </ol>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-light">
          <strong>üê± Life Stage Factors</strong>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            <li><strong>Kittens 0‚Äì4 months:</strong> 2.5 √ó RER (rapid growth)</li>
            <li><strong>Kittens 4‚Äì12 months:</strong> 2.0 √ó RER (moderate growth)</li>
            <li><strong>Adult (Neutered):</strong> 1.2 √ó RER (maintenance)</li>
            <li><strong>Adult (Not Neutered):</strong> 1.4 √ó RER (higher activity)</li>
            <li><strong>Adult (Prone to Obesity):</strong> 1.0 √ó RER (weight management)</li>
          </ul>
        </div>
      </div>

      <div class="alert alert-warning">
        <strong>‚ö†Ô∏è Important:</strong> These are starting points based on scientific formulas. 
        Always adjust by 10‚Äì20% based on your cat's body condition, activity level, and your veterinarian's advice.
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Toggle profile section
function toggleProfileSection() {
  const section = document.getElementById('profileSection');
  const icon = document.getElementById('profileToggleIcon');
  if (section.style.display === 'none') {
    section.style.display = 'block';
    icon.textContent = '‚ñº';
  } else {
    section.style.display = 'none';
    icon.textContent = '‚ñ∂';
  }
}

// Auto-collapse profile section if saved and has name
{% if show_success and prof and prof.name %}
  document.addEventListener('DOMContentLoaded', function() {
    const section = document.getElementById('profileSection');
    const icon = document.getElementById('profileToggleIcon');
    if (section) {
      section.style.display = 'none';
      if (icon) icon.textContent = '‚ñ∂';
    }
  });
{% endif %}

// Charts
const trend = {{ trend|tojson }};
const labels = trend.map(r => r.dt);
const wdata  = trend.map(r => r.weight_kg);
const kdata  = trend.map(r => r.der_kcal);

if (labels.length > 0) {
  new Chart(document.getElementById('wChart'), {
    type: 'line',
    data: { 
      labels: labels, 
      datasets: [{ 
        label: 'Weight (kg)', 
        data: wdata,
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.1
      }] 
    },
    options: { 
      responsive: true, 
      scales: { 
        y: { title: { display: true, text: 'Weight (kg)' } }, 
        x: { ticks: { maxRotation: 45 } } 
      } 
    }
  });
  new Chart(document.getElementById('kChart'), {
    type: 'line',
    data: { 
      labels: labels, 
      datasets: [{ 
        label: 'Daily Calories (kcal)', 
        data: kdata,
        borderColor: 'rgb(255, 99, 132)',
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        tension: 0.1
      }] 
    },
    options: { 
      responsive: true, 
      scales: { 
        y: { title: { display: true, text: 'Calories per Day (kcal)' } } 
      } 
    }
  });
}
</script>
</body>
</html>
