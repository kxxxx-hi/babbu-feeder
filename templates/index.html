<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kitten Feeding Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .kmono { font-variant-numeric: tabular-nums; }
    .table-sm td, .table-sm th { padding: .35rem; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h3 class="mb-3">Kitten Calorie & Feeding Planner</h3>

  <!-- Profile -->
  <div class="card mb-3">
    <div class="card-header">Profile</div>
    <div class="card-body">
      <form method="post" class="row g-3">
        <input type="hidden" name="action" value="save_profile">
        <div class="col-md-3">
          <label class="form-label">Cat name</label>
          <input name="name" value="{{ prof.name or '' }}" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Anchor date</label>
          <input type="date" name="anchor_date" value="{{ prof.anchor_date }}" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Starting age (weeks)</label>
          <input type="number" step="0.5" name="anchor_age_weeks" value="{{ prof.anchor_age_weeks }}" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Meals/day</label>
          <input type="number" name="meals_per_day" min="1" max="12" value="{{ prof.meals_per_day }}" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Life stage override</label>
          <select name="life_stage_override" class="form-select">
            {% set stages = ["", "kitten_0_4m","kitten_4_12m","adult_neutered","adult_intact","adult_obese_prone"] %}
            {% for s in stages %}
            <option value="{{ s }}" {% if prof.life_stage_override==s %}selected{% endif %}>{{ s if s else "(auto)" }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12">
          <button class="btn btn-primary">Save profile</button>
          <span class="ms-3">Age now: <b class="kmono">{{ "%.1f"|format(age_weeks) }}</b> wk. Stage: <b>{{ stage }}</b></span>
        </div>
      </form>
    </div>
  </div>

  <!-- Quick stats -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <div>Latest weight (kg)</div>
          <div class="h4 kmono">{{ "%.3f"|format(latest_w) if latest_w else "—" }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <div>Daily target kcal</div>
          <div class="h4 kmono">{{ "%.0f"|format(daily_kcal) if daily_kcal else "—" }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <div>Meals/day</div>
          <div class="h4 kmono">{{ prof.meals_per_day }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="tabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dash" type="button">Dashboard</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#log" type="button">Log data</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#foods" type="button">Foods</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#diet" type="button">Diet planner</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#calc" type="button">Calculations & sources</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#data" type="button">Data</button></li>
  </ul>

  <div class="tab-content border border-top-0 p-3 bg-white">
    <!-- Dashboard -->
    <div class="tab-pane fade show active" id="dash">
      <h6>Per-meal plan</h6>
      {% if per_meal|length == 0 %}
      <div class="text-muted">Add weights and a 100% diet to see amounts.</div>
      {% else %}
      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr><th>Food</th><th>% kcal/day</th><th>kcal/day</th><th>kcal/meal</th><th>Qty/meal</th><th>Unit</th><th>Grams/meal</th></tr></thead>
          <tbody>
          {% for r in per_meal %}
            <tr>
              <td>{{ r.Food }}</td>
              <td class="kmono">{{ "%.1f"|format(r.pct) }}</td>
              <td class="kmono">{{ "%.1f"|format(r.kcal_day) }}</td>
              <td class="kmono">{{ "%.1f"|format(r.kcal_meal) }}</td>
              <td class="kmono">{{ "%.3f"|format(r.qty_per_meal) }}</td>
              <td>{{ r.unit }}</td>
              <td class="kmono">{{ r.grams_per_meal if r.grams_per_meal is not none else "—" }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <div class="row g-3">
        <div class="col-md-6">
          <h6>Weight over time</h6>
          <canvas id="wChart"></canvas>
        </div>
        <div class="col-md-6">
          <h6>Target kcal/day over time</h6>
          <canvas id="kChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Log data -->
    <div class="tab-pane fade" id="log">
      <form method="post" class="row g-3">
        <input type="hidden" name="action" value="add_weight">
        <div class="col-md-3">
          <label class="form-label">Date</label>
          <input type="date" name="weight_dt" value="{{ (weights_list[-1].dt if weights_list|length>0 else '') or (('%Y-%m-%d')|strftime) }}" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Weight (kg)</label>
          <input type="number" step="0.01" min="0.1" name="weight_kg" class="form-control" required>
        </div>
        <div class="col-md-3 align-self-end">
          <button class="btn btn-primary">Save weight</button>
        </div>
      </form>
      <div class="table-responsive mt-3">
        <table class="table table-sm">
          <thead><tr><th>Date</th><th>Weight (kg)</th></tr></thead>
          <tbody>
          {% for r in weights_list|reverse %}
            <tr><td class="kmono">{{ r.dt }}</td><td class="kmono">{{ "%.3f"|format(r.weight_kg) }}</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Foods -->
    <div class="tab-pane fade" id="foods">
      <form method="post" class="row g-3">
        <input type="hidden" name="action" value="add_food">
        <div class="col-md-3"><label class="form-label">Name</label><input name="food_name" class="form-control" required></div>
        <div class="col-md-3">
          <label class="form-label">Unit</label>
          <select name="food_unit" class="form-select">
            <option value="kcal_per_g">kcal_per_g</option>
            <option value="kcal_per_cup">kcal_per_cup</option>
          </select>
        </div>
        <div class="col-md-3"><label class="form-label">Calories per unit</label><input type="number" step="0.1" name="kcal_per_unit" class="form-control" required></div>
        <div class="col-md-3"><label class="form-label">Grams per cup (if per cup)</label><input type="number" step="1" name="grams_per_cup" class="form-control"></div>
        <div class="col-12"><button class="btn btn-primary">Add food</button></div>
      </form>

      <hr>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr><th>ID</th><th>Name</th><th>Unit</th><th>kcal/unit</th><th>g/cup</th><th></th></tr></thead>
          <tbody>
          {% for f in foods %}
            <tr>
              <td class="kmono">{{ f.id }}</td>
              <td>{{ f.name }}</td>
              <td>{{ f.unit }}</td>
              <td class="kmono">{{ "%.1f"|format(f.kcal_per_unit) }}</td>
              <td class="kmono">{{ f.grams_per_cup if f.grams_per_cup else "—" }}</td>
              <td>
                <form method="post" class="d-inline">
                  <input type="hidden" name="action" value="delete_food">
                  <input type="hidden" name="del_food_id" value="{{ f.id }}">
                  <button class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Diet -->
    <div class="tab-pane fade" id="diet">
      <form method="post">
        <input type="hidden" name="action" value="save_diet">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>Food</th><th>% kcal/day</th></tr></thead>
            <tbody>
            {% for f in foods %}
              <tr>
                <td>{{ f.name }}</td>
                <td style="max-width:160px;">
                  <input class="form-control form-control-sm" type="number" step="1" min="0" max="100"
                         name="diet_pct_{{ f.id }}" value="{{ diet_map.get(f.id, 0.0) }}">
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        <p>Total: <b class="kmono">{{ "%.1f"|format(total_pct) }}</b>% (must be 100%)</p>
        <button class="btn btn-primary">Save diet</button>
      </form>
    </div>

    <!-- Calculations -->
    <div class="tab-pane fade" id="calc">
      <h6>How calorie targets are calculated</h6>
      <ul>
        <li>RER = 70 × BW(kg)<sup>0.75</sup></li>
        <li>DER = RER × factor</li>
      </ul>
      <p>Factors used:</p>
      <ul>
        <li>Kittens 0–4 months: 2.5 × RER</li>
        <li>Kittens 4–12 months: 2.0 × RER</li>
        <li>Adult neutered: 1.2 × RER</li>
        <li>Adult intact: 1.4 × RER</li>
        <li>Adult obese-prone: 1.0 × RER</li>
      </ul>
      <p>These are starting points. Adjust by 10–20% based on body condition and your vet’s advice.</p>
    </div>

    <!-- Data -->
    <div class="tab-pane fade" id="data">
      <h6>Raw tables</h6>
      <div class="row">
        <div class="col-md-6">
          <h6>Weights</h6>
          <table class="table table-sm">
            <thead><tr><th>Date</th><th>Weight_kg</th></tr></thead>
            <tbody>
            {% for r in weights_list %}
              <tr><td class="kmono">{{ r.dt }}</td><td class="kmono">{{ "%.3f"|format(r.weight_kg) }}</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="col-md-6">
          <h6>Foods</h6>
          <table class="table table-sm">
            <thead><tr><th>ID</th><th>Name</th><th>Unit</th><th>kcal/unit</th><th>g/cup</th></tr></thead>
            <tbody>
            {% for f in foods %}
              <tr><td class="kmono">{{ f.id }}</td><td>{{ f.name }}</td><td>{{ f.unit }}</td><td class="kmono">{{ "%.1f"|format(f.kcal_per_unit) }}</td><td class="kmono">{{ f.grams_per_cup if f.grams_per_cup else "—" }}</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Charts
const trend = {{ trend|tojson }};
const labels = trend.map(r => r.dt);
const wdata  = trend.map(r => r.weight_kg);
const kdata  = trend.map(r => r.der_kcal);

if (labels.length > 0) {
  new Chart(document.getElementById('wChart'), {
    type: 'line',
    data: { labels: labels, datasets: [{ label: 'kg', data: wdata }] },
    options: { responsive: true, scales: { y: { title: { display: true, text: 'kg' } }, x: { ticks: { maxRotation: 0 } } } }
  });
  new Chart(document.getElementById('kChart'), {
    type: 'line',
    data: { labels: labels, datasets: [{ label: 'kcal/day', data: kdata }] },
    options: { responsive: true, scales: { y: { title: { display: true, text: 'kcal/day' } } } }
  });
}
</script>
</body>
</html>
